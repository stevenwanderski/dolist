<div id="tasks">
  <% if tasks.any? %>
    <div class="mb-3" data-sortable-tasks>
      <% tasks.each do |task| %>
        <%= turbo_frame_tag "#{dom_id(task)}_edit", class: 'group block bg-zinc-900 border-b border-b-zinc-700 relative flex justify-between items-center py-2', data: { task_id: task.id } do %>
          <div class="opacity-0 group-hover:opacity-100 absolute -left-[25px] pr-[5px]">
            <%= heroicon 'bars-3', options: { class: 'h-5 w-5 cursor-move text-zinc-300', data_handle: true } %>
          </div>

          <div class="flex items-center gap-2">
            <%= link_to complete_users_project_task_path(@project, task), data: { turbo_method: :post }, class: 'group/check w-[18px] h-[18px] rounded-full border border-zinc-400' do %>
              <%= heroicon 'check', options: { class: 'group-hover/check:opacity-100 opacity-0 transition-opacity duration-200 text-zinc-400 w-3 h-3 mt-[2px] ml-[2px]' } %>
            <% end %>

            <div class="text-sm text-zinc-200">
              <%= task.name %>
            </div>
          </div>

          <div x-data="{ open: false }" class="h-5 flex items-center relative hover:bg-zinc-700 rounded">
            <%= heroicon 'ellipsis-horizontal',
                options: {
                  class: 'h-8 w-8 text-slate-100 cursor-pointer',
                  '@click' => 'open = true',
                  '@click.outside' => 'open = false'
                }
            %>

            <div x-show="open" x-cloak class="absolute top-6 right-0 min-w-[200px] z-10 rounded-xl border border-zinc-600 bg-zinc-800">
              <div class="divide-y divide-zinc-700">
                <div class="px-1.5 py-1.5">
                  <%= link_to edit_users_project_task_path(@project, task), class: 'flex gap-2 items-center text-[13px] py-2 px-3 hover:bg-zinc-700 rounded' do %>
                    <%= heroicon 'pencil-square', options: { class: 'h-5 w-5 text-slate-100' } %>
                    <span>Edit</span>
                  <% end %>
                </div>

                <div class="px-1.5 py-1.5">
                  <%= link_to users_project_task_path(@project, task), class: 'flex gap-2 items-center text-[13px] py-2 px-3 hover:bg-zinc-700 rounded', data: { turbo_method: :delete, turbo_confirm: 'Are you sure?' } do %>
                    <%= heroicon 'trash', options: { class: 'h-5 w-5 text-slate-100' } %>
                    <span>Delete</span>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
  <% end %>
</div>

<script>
  $('[data-sortable-tasks]').sortable({
    handle: '[data-handle]',
    placeholder: 'sortable-placeholder',

    update(event, ui) {
      const index = ui.item.index();
      const taskId = ui.item.data('task-id');

      fetch(`/app/projects/<%= @project.id %>/tasks/${taskId}/update_weight`, {
        method: 'POST',
        body: JSON.stringify({ weight: index + 1 }),
        headers: {
          "Content-Type": "application/json",
        }
      });
    }
  })
</script>
